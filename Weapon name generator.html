<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sci‚ÄëFi Weapon Generator ‚Äî Names + Technical Specs</title>
  <style>
    :root{
      --bg:#070A12;
      --panel:rgba(14,18,32,.78);
      --panel2:rgba(18,24,46,.78);
      --text:#EAF0FF;
      --muted:#A9B4D6;
      --line:rgba(255,255,255,.12);
      --accent:#7AA8FF;
      --accent2:#9BFFD7;
      --warn:#FFCF6E;
      --bad:#FF7A7A;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:var(--bg);
      overflow-x:hidden;
    }

    /* Background canvas */
    #bgCanvas{
      position:fixed;
      inset:0;
      z-index:-2;
      width:100vw;
      height:100vh;
      display:block;
    }
    .vignette{
      position:fixed;
      inset:0;
      z-index:-1;
      pointer-events:none;
      background:radial-gradient(1200px 600px at 20% 10%, rgba(122,168,255,.18), transparent 55%),
                 radial-gradient(1000px 500px at 80% 25%, rgba(155,255,215,.12), transparent 55%),
                 radial-gradient(1200px 900px at 50% 85%, rgba(0,0,0,.55), rgba(0,0,0,.88));
    }

    .wrap{
      width:min(1100px, calc(100% - 32px));
      margin: 28px auto 56px;
    }

    header{
      display:flex;
      gap:16px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:16px;
    }

    h1{
      margin:0;
      font-size: clamp(22px, 3vw, 34px);
      letter-spacing:.3px;
    }
    .sub{
      margin:8px 0 0;
      color:var(--muted);
      line-height:1.4;
      max-width: 70ch;
    }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(0,0,0,.15);
      color:var(--muted);
      font-size:13px;
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
    }

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, var(--panel), rgba(10,12,22,.70));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .hd strong{ letter-spacing:.2px; }
    .card .bd{ padding:16px; }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .controls .row{ grid-column: 1 / -1; }
    @media (max-width: 520px){
      .controls{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      letter-spacing:.2px;
    }
    select,input{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
    }
    input::placeholder{ color: rgba(234,240,255,.45); }

    .checkline{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .checkline label{
      margin:0;
      font-size:13px;
      color:var(--text);
      opacity:.9;
      display:flex;
      gap:8px;
      align-items:center;
      cursor:pointer;
      user-select:none;
    }
    .checkline input[type="checkbox"]{ width: 16px; height: 16px; }

    .btnrow{ display:flex; flex-wrap:wrap; gap:10px; margin-top:14px; }
    button{
      appearance:none;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.25);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
    }
    button:hover{ border-color: rgba(122,168,255,.55); background: rgba(122,168,255,.10); }
    button:active{ transform: translateY(1px); }
    .primary{
      border-color: rgba(122,168,255,.6);
      background: linear-gradient(180deg, rgba(122,168,255,.22), rgba(0,0,0,.18));
    }

    .outTitle{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .name{
      font-size: 22px;
      line-height:1.2;
      letter-spacing:.25px;
      margin:0;
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
      color: var(--muted);
      font-size: 13px;
    }
    .tag{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding: 6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
    }

    .split{
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:16px;
      align-items:start;
      margin-top: 14px;
    }
    @media (max-width: 820px){
      .split{ grid-template-columns: 1fr; }
    }

    .panel{
      background: linear-gradient(180deg, var(--panel2), rgba(0,0,0,.15));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .panel .ph{ padding:10px 12px; border-bottom:1px solid var(--line); color: var(--muted); font-size:12px; letter-spacing:.2px; }
    .panel .pb{ padding: 12px; }

    table{
      width:100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    td{
      padding: 8px 8px;
      border-bottom: 1px solid rgba(255,255,255,.07);
      vertical-align: top;
    }
    td:first-child{ color: var(--muted); width: 42%; }

    .mono{
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
      margin:0;
      color: rgba(234,240,255,.88);
    }

    .notice{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }

    .error{
      border-color: rgba(255,122,122,.45) !important;
      background: rgba(255,122,122,.10) !important;
    }

    .small{ font-size:12px; color: var(--muted); }
    .hr{ height:1px; background: rgba(255,255,255,.10); margin: 10px 0; }
  </style>
</head>
<body>
  <canvas id="bgCanvas" aria-hidden="true"></canvas>
  <div class="vignette" aria-hidden="true"></div>

  <div class="wrap">
    <header>
      <div>
        <h1>Sci‚ÄëFi Weapon Generator</h1>
        <p class="sub">Procedurally generate weapon names and fictional technical specifications for worldbuilding: projectile, energy, missiles/ordnance, and exotic systems ‚Äî complete with manufacturer, service tags, and a short lore note.</p>
      </div>
      <div class="pill" title="Fictional worldbuilding tool">
        <span>üõ†Ô∏è</span>
        <span>Fictional specs ‚Ä¢ Seedable ‚Ä¢ Exportable</span>
      </div>
    </header>

    <div class="grid">
      <!-- Controls -->
      <section class="card">
        <div class="hd">
          <strong>Generator controls</strong>
          <span class="small">Tip: Use a seed to reproduce results.</span>
        </div>
        <div class="bd">
          <div class="controls">
            <div>
              <label for="category">Category</label>
              <select id="category">
                <option value="projectile">Projectile / kinetic</option>
                <option value="energy">Energy</option>
                <option value="missile">Missiles / ordnance</option>
                <option value="exotic">Exotic / experimental</option>
                <option value="any">Any (mixed)</option>
              </select>
            </div>
            <div>
              <label for="tier">Tier</label>
              <select id="tier">
                <option value="common">Common</option>
                <option value="uncommon">Uncommon</option>
                <option value="rare" selected>Rare</option>
                <option value="epic">Epic</option>
                <option value="legendary">Legendary</option>
              </select>
            </div>

            <div>
              <label for="faction">Faction / origin</label>
              <select id="faction"></select>
            </div>
            <div>
              <label for="manufacturer">Manufacturer</label>
              <select id="manufacturer"></select>
            </div>

            <div class="row">
              <label for="seed">Seed (optional)</label>
              <input id="seed" placeholder="e.g. ORPHEUS‚Äë7 / any phrase" />
            </div>

            <div>
              <label for="count">Batch size</label>
              <input id="count" type="number" min="1" max="20" value="1" />
            </div>
            <div>
              <label for="format">Export format</label>
              <select id="format">
                <option value="json" selected>JSON</option>
                <option value="md">Markdown</option>
                <option value="txt">Plain text</option>
              </select>
            </div>
          </div>

          <div class="checkline">
            <label><input id="includeNickname" type="checkbox" checked />Include nickname</label>
            <label><input id="includeLore" type="checkbox" checked />Include lore note</label>
            <label><input id="highCrunch" type="checkbox" />More technical detail</label>
          </div>

          <div class="btnrow">
            <button class="primary" id="btnGenerate">Generate</button>
            <button id="btnBatch">Generate batch</button>
            <button id="btnCopyName">Copy name</button>
            <button id="btnCopyJSON">Copy data</button>
            <button id="btnDownload">Download export</button>
          </div>

          <div class="notice">
            Note: all outputs are fictional and intended for sci‚Äëfi writing and tabletop worldbuilding.
          </div>
        </div>
      </section>

      <!-- Output -->
      <section class="card">
        <div class="hd">
          <strong>Output</strong>
          <span class="small" id="status">Ready.</span>
        </div>
        <div class="bd" id="out">
          <p class="small">Click <b>Generate</b> to create a weapon profile.</p>
        </div>
      </section>
    </div>
  </div>

  <script>
    "use strict";

    // -----------------------------
    // Seeded RNG (xmur3 + sfc32)
    // -----------------------------
    function xmur3(str){
      let h = 1779033703 ^ str.length;
      for (let i = 0; i < str.length; i++){
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = (h << 13) | (h >>> 19);
      }
      return function(){
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        return (h ^= (h >>> 16)) >>> 0;
      };
    }

    function sfc32(a,b,c,d){
      return function(){
        a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0;
        let t = (a + b) | 0;
        a = b ^ (b >>> 9);
        b = (c + (c << 3)) | 0;
        c = (c << 21) | (c >>> 11);
        d = (d + 1) | 0;
        t = (t + d) | 0;
        c = (c + t) | 0;
        return (t >>> 0) / 4294967296;
      };
    }

    function makeRng(seed){
      const s = xmur3(String(seed));
      return sfc32(s(), s(), s(), s());
    }

    // -----------------------------
    // Helpers
    // -----------------------------
    const clamp = (v,min,max)=>Math.max(min, Math.min(max, v));
    const randInt = (rng,min,max)=> Math.floor(rng()*(max-min+1))+min;
    const randBetween = (rng,min,max)=> rng()*(max-min)+min;
    const pick = (rng,arr)=> arr[Math.floor(rng()*arr.length)];

    function pickWeighted(rng, entries){
      // entries: [{item, w}, ...]
      let total = 0;
      for (const e of entries) total += e.w;
      let roll = rng()*total;
      for (const e of entries){
        roll -= e.w;
        if (roll <= 0) return e.item;
      }
      return entries[entries.length-1].item;
    }

    function roman(n){
      const map = [
        [1000,"M"],[900,"CM"],[500,"D"],[400,"CD"],
        [100,"C"],[90,"XC"],[50,"L"],[40,"XL"],
        [10,"X"],[9,"IX"],[5,"V"],[4,"IV"],[1,"I"]
      ];
      let out = "";
      for (const [v,s] of map){
        while (n >= v){ out += s; n -= v; }
      }
      return out;
    }

    function fmt(n, dp=0){
      const pow = Math.pow(10,dp);
      const v = Math.round(n*pow)/pow;
      return v.toLocaleString(undefined, {minimumFractionDigits:dp, maximumFractionDigits:dp});
    }

    function safeNumberInput(el, min, max, fallback){
      const v = Number(el.value);
      if (!Number.isFinite(v)) return fallback;
      return clamp(Math.floor(v), min, max);
    }

    function setStatus(msg, isBad=false){
      const s = document.getElementById("status");
      s.textContent = msg;
      s.style.color = isBad ? "var(--bad)" : "var(--muted)";
    }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch{
        // Fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try{
          const ok = document.execCommand("copy");
          document.body.removeChild(ta);
          return ok;
        }catch{
          document.body.removeChild(ta);
          return false;
        }
      }
    }

    function downloadBlob(filename, content, mime){
      const blob = new Blob([content], {type: mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    // -----------------------------
    // Datasets
    // -----------------------------
    const TIERS = {
      common:    {label:"Common",    mult:1.00, quirks:1},
      uncommon:  {label:"Uncommon",  mult:1.05, quirks:2},
      rare:      {label:"Rare",      mult:1.12, quirks:2},
      epic:      {label:"Epic",      mult:1.24, quirks:3},
      legendary: {label:"Legendary", mult:1.40, quirks:4},
    };

    const FACTIONS = [
      { id:"orpheus", name:"Orpheus Combine" },
      { id:"helios", name:"Helios Directorate" },
      { id:"tethys", name:"Tethys Freeholds" },
      { id:"morrow", name:"Morrow Pact" },
      { id:"caelum", name:"Caelum Relay Authority" },
      { id:"kestrel", name:"Kestrel Spur Cartel" },
      { id:"sable",  name:"Sable Choir" },
      { id:"vanta",  name:"Vanta Sovereignty" },
    ];

    const MANUFACTURERS = [
      { id:"ares",  name:"Ares Dynamics" },
      { id:"novatek", name:"Novatek Armature" },
      { id:"ceres", name:"Ceres Forgeworks" },
      { id:"ion",   name:"ION‚ÄëMorrow Systems" },
      { id:"eidolon", name:"Eidolon Precision" },
      { id:"umbra", name:"Umbra Foundry" },
      { id:"caldera", name:"Caldera Ordinance" },
      { id:"prax",  name:"Prax Defence Instruments" },
      { id:"atlas", name:"Atlas Astral Yards" },
      { id:"lyra",  name:"Lyra Microtech" },
    ];

    const NAME_BITS = {
      adjectives: ["Vigilant","Silent","Tempest","Sable","Starlit","Grim","Hallowed","Apex","Cerulean","Razor","Warden","Kinetic","Solar","Obsidian","Argent","Cinder","Void","Iron","Ghost","Penumbral","Thunder","Nova","Eclipse"],
      nouns: ["Lance","Wraith","Harrier","Bulwark","Anvil","Fang","Spear","Crown","Mantis","Valkyrie","Peregrine","Hydra","Gorgon","Eidolon","Glaive","Viper","Hammer","Sirocco","Aegis","Revenant","Orchid","Aurora","Gravemark"],
      cosmic: ["Perihelion","Apogee","Eventide","Redshift","Umbrafall","Riftline","Zenith","Nadir","Afterglow","Heliotrope","K‚ÄëLine","Lagrange","Coldpoint","Transit","Blackwake"],
      animals: ["Jackal","Kite","Marauder","Shrike","Leopard","Cobra","Raven","Moth","Scarab","Wolf","Stag","Manta","Eel","Badger","Osprey"],
      variants: ["VX","XR","Delta","Sigma","Spectre","Ward","Skirmish","Breach","Arc","Nova","Eclipse","Hush","Longreach","Overwatch"],
      features: ["adaptive recoil lattice","smart‚Äëlink fire control","ceramic heat‚Äësink fins","mag‚Äësealed action","self‚Äëcalibrating optics","tunable accelerator coils","shock‚Äëdamped stock","micro‚Äëfracture resistant rails","low‚Äësignature muzzle array","autoloader spool","EM hardening","field‚Äëswap barrel kit","overpressure venting","anti‚Äëfouling nano‚Äëcoat"],
      missileFeatures: ["multi‚Äëmode seeker","inertial nav + stellar fix","cold‚Äëlaunch canister","swarm hand‚Äëoff mesh","adaptive thrust vectoring","countermeasure discrimination","terminal pop‚Äëup profile","loiter programme","hardened datalink","flare‚Äëblind optics","anti‚Äëjamming spread spectrum"],
      energyFeatures: ["phase‚Äëlocked emitters","variable pulse shaping","spectral notch tuning","superconducting bus","cryogenic pre‚Äëcool loop","beam collimation array","plasma sheath stabiliser","automatic lens purge","capacitor rapid‚Äëcharge","magnetic bottle regulator","radiator bloom"],
      exoticFeatures: ["metamaterial field shroud","gravity lensing collar","entangled timing gate","null‚Äëfield baffle","inertial damp subframe","quantum lock governor","vacuum‚Äëphase injector","anomalous containment cage","non‚Äëlinear harmonics"],
    };

    // -----------------------------
    // Category generation
    // -----------------------------
    function makeDesignation(rng, category){
      const pool = {
        projectile: ["K","AR","BR","DM","AC","GC"],
        energy:     ["LAS","ION","PLS","PB","MW"],
        missile:    ["SRM","MRM","LRM","TRP","CRS"],
        exotic:     ["RG","GSS","GRV","AM","EMP","NAN"],
      };
      const p = pick(rng, pool[category] || pool.projectile);
      const num = randInt(rng, 7, 99);
      const suf = rng() < 0.35 ? String.fromCharCode(65 + randInt(rng,0,4)) : "";
      return `${p}-${num}${suf}`;
    }

    function makeNickname(rng){
      // Nicknames are short and punchy
      const style = pickWeighted(rng, [
        {item:"adj+noun", w:50},
        {item:"cosmic", w:30},
        {item:"animal", w:20},
      ]);
      if (style === "adj+noun") return `${pick(rng, NAME_BITS.adjectives)} ${pick(rng, NAME_BITS.nouns)}`;
      if (style === "cosmic") return pick(rng, NAME_BITS.cosmic);
      return pick(rng, NAME_BITS.animals);
    }

    function makeWeaponName(rng, manufacturer, category, includeNickname){
      const mark = `Mk ${roman(randInt(rng,1,12))}`;
      const designation = makeDesignation(rng, category);
      const variant = rng() < 0.72 ? pick(rng, NAME_BITS.variants) : "";
      const nickname = includeNickname && rng() < 0.82 ? ` ‚Äú${makeNickname(rng)}‚Äù` : "";
      const vPart = variant ? ` ${variant}` : "";
      return `${manufacturer} ${designation} ${mark}${vPart}${nickname}`;
    }

    function kJFromBullet(mass_g, v_ms){
      const m = mass_g / 1000;
      return 0.5 * m * v_ms * v_ms / 1000; // kJ
    }

    function genProjectile(rng, tier, highCrunch){
      const roles = [
        {item:"PDW", w:16},
        {item:"Carbine", w:20},
        {item:"Battle rifle", w:18},
        {item:"Designated marksman rifle", w:14},
        {item:"LMG", w:12},
        {item:"Autocannon", w:14},
        {item:"Shipboard coil‚Äëassisted gun", w:6},
      ];
      const role = pickWeighted(rng, roles);

      let calibre, mass_g, v_ms, rof, mag;
      if (role === "PDW"){
        calibre = randBetween(rng, 4.6, 6.2);
        mass_g = randBetween(rng, 2.0, 4.5);
        v_ms = randBetween(rng, 650, 880);
        rof = randInt(rng, 750, 1100);
        mag = randInt(rng, 30, 60);
      } else if (role === "Carbine"){
        calibre = randBetween(rng, 5.0, 7.0);
        mass_g = randBetween(rng, 3.5, 8.5);
        v_ms = randBetween(rng, 720, 980);
        rof = randInt(rng, 650, 950);
        mag = randInt(rng, 25, 45);
      } else if (role === "Battle rifle"){
        calibre = randBetween(rng, 6.8, 9.0);
        mass_g = randBetween(rng, 8.5, 13.5);
        v_ms = randBetween(rng, 760, 980);
        rof = randInt(rng, 500, 800);
        mag = randInt(rng, 15, 30);
      } else if (role === "Designated marksman rifle"){
        calibre = randBetween(rng, 7.5, 10.5);
        mass_g = randBetween(rng, 10, 16);
        v_ms = randBetween(rng, 820, 1050);
        rof = randInt(rng, 250, 520);
        mag = randInt(rng, 10, 25);
      } else if (role === "LMG"){
        calibre = randBetween(rng, 6.0, 8.5);
        mass_g = randBetween(rng, 7.5, 12.0);
        v_ms = randBetween(rng, 780, 980);
        rof = randInt(rng, 750, 1200);
        mag = pickWeighted(rng, [
          {item: randInt(rng, 60, 120) + "‚Äërd box", w:55},
          {item: randInt(rng, 150, 350) + "‚Äërd belt", w:45},
        ]);
      } else if (role === "Autocannon"){
        calibre = randBetween(rng, 18, 35);
        mass_g = randBetween(rng, 40, 180);
        v_ms = randBetween(rng, 980, 1450);
        rof = randInt(rng, 180, 650);
        mag = pickWeighted(rng, [
          {item: randInt(rng, 20, 50) + "‚Äërd drum", w:45},
          {item: randInt(rng, 80, 250) + "‚Äërd feed", w:55},
        ]);
      } else {
        calibre = randBetween(rng, 35, 120);
        mass_g = randBetween(rng, 120, 900);
        v_ms = randBetween(rng, 1200, 2400);
        rof = randInt(rng, 20, 180);
        mag = pickWeighted(rng, [
          {item: randInt(rng, 6, 18) + "‚Äërd magazine", w:55},
          {item: randInt(rng, 20, 60) + "‚Äërd feed", w:45},
        ]);
      }

      const mult = tier.mult;
      v_ms *= mult;
      rof = Math.round(rof * (0.92 + (mult-1)*0.6));

      const ammoType = pickWeighted(rng, [
        {item:"APFSDS micro‚Äëdart", w:22},
        {item:"cased telescoped", w:22},
        {item:"smart‚Äëfused airburst", w:14},
        {item:"match‚Äëgrade FMJ", w:18},
        {item:"fragmenting sabot", w:10},
        {item:"ferromagnetic flechette", w:14},
      ]);

      const recoil = randBetween(rng, 0.6, 1.6) * (role.includes("Autocannon") ? 2.1 : 1.0);
      const mass_kg = randBetween(rng, 2.4, 6.2) + (role.includes("LMG") ? 1.4 : 0) + (role.includes("Autocannon") ? 7 : 0);
      const range_m = Math.round(randBetween(rng, 250, 800) * (role.includes("marksman") ? 1.8 : 1.0) * (role.includes("Autocannon") ? 2.2 : 1.0) * (0.95 + (mult-1)*0.9));
      const moa = randBetween(rng, 0.8, 3.2) * (role.includes("marksman") ? 0.55 : 1.0) * (role.includes("Autocannon") ? 2.6 : 1.0);
      const energy_kJ = kJFromBullet(mass_g, v_ms);

      const extras = [];
      const extraCount = tier.quirks + (highCrunch ? 1 : 0);
      while (extras.length < extraCount){
        const f = pick(rng, NAME_BITS.features);
        if (!extras.includes(f)) extras.push(f);
      }

      const out = {
        Role: role,
        "Calibre": `${fmt(calibre, calibre < 15 ? 1 : 0)} mm`,
        "Ammunition": ammoType,
        "Muzzle velocity": `${fmt(v_ms, 0)} m/s`,
        "Muzzle energy": `${fmt(energy_kJ, energy_kJ < 10 ? 1 : 0)} kJ`,
        "Cyclic rate": `${fmt(rof,0)} rpm`,
        "Feed": String(mag),
        "Effective range": `${fmt(range_m,0)} m`,
        "Intrinsic accuracy": `${fmt(moa,1)} MOA`,
        "Mass": `${fmt(mass_kg,1)} kg`,
        "Recoil index": `${fmt(recoil,2)} (rel.)`,
      };

      if (highCrunch){
        const barrel_cm = randInt(rng, 18, 66) + (role.includes("marksman") ? 12 : 0) + (role.includes("Autocannon") ? 80 : 0);
        const action = pickWeighted(rng, [
          {item:"short‚Äëstroke piston", w:28},
          {item:"roller‚Äëdelayed", w:16},
          {item:"electromagnetic assist", w:18},
          {item:"recoilless counter‚Äëmass", w:10},
          {item:"rotary breech", w:12},
          {item:"vacuum‚Äësealed linear action", w:16},
        ]);
        out["Barrel length"] = `${fmt(barrel_cm,0)} cm`;
        out["Action"] = action;
        out["Signature"] = pickWeighted(rng, [
          {item:"low", w:30},
          {item:"moderate", w:55},
          {item:"high", w:15},
        ]);
      }

      return { specs: out, features: extras };
    }

    function genEnergy(rng, tier, highCrunch){
      const types = [
        {item:"Laser rifle", w:34},
        {item:"Particle beam projector", w:16},
        {item:"Plasma caster", w:18},
        {item:"Ion carbine", w:20},
        {item:"Microwave disruptor", w:12},
      ];
      const role = pickWeighted(rng, types);
      const mult = tier.mult;

      let range_m = randBetween(rng, 220, 900) * (role.includes("Particle") ? 1.6 : 1.0) * (role.includes("Microwave") ? 0.9 : 1.0) * (0.95 + (mult-1)*0.95);
      let power_MW = randBetween(rng, 0.08, 0.65) * (role.includes("Plasma") ? 1.4 : 1.0) * (role.includes("Particle") ? 1.8 : 1.0) * (0.95 + (mult-1)*0.85);
      let output_MW = power_MW * randBetween(rng, 0.55, 0.86);

      const pulse_ms = randBetween(rng, 1.2, 18) * (role.includes("Microwave") ? 8 : 1);
      const cap_MJ = power_MW * randBetween(rng, 0.6, 2.8);
      const cooling_kW = randBetween(rng, 0.7, 4.2) * power_MW * 100;
      const mass_kg = randBetween(rng, 2.6, 7.2) * (role.includes("Particle") ? 1.25 : 1.0) * (role.includes("Plasma") ? 1.15 : 1.0);

      const extras = [];
      const extraCount = tier.quirks + (highCrunch ? 1 : 0);
      while (extras.length < extraCount){
        const f = pick(rng, NAME_BITS.energyFeatures);
        if (!extras.includes(f)) extras.push(f);
      }

      const out = {
        Role: role,
        "Effective range": `${fmt(range_m,0)} m`,
        "Power draw": `${fmt(power_MW,2)} MW`,
        "Emitter output": `${fmt(output_MW,2)} MW`,
        "Pulse duration": `${fmt(pulse_ms, role.includes("Microwave") ? 1 : 2)} ms`,
        "Capacitor": `${fmt(cap_MJ,2)} MJ`,
        "Thermal load": `${fmt(cooling_kW,0)} kW`,
        "Mass": `${fmt(mass_kg,1)} kg`,
      };

      if (highCrunch){
        out["Wavelength / band"] = pickWeighted(rng, [
          {item:"near‚ÄëIR (980‚Äì1550 nm)", w:22},
          {item:"visible (520‚Äì650 nm)", w:10},
          {item:"shortwave UV (280‚Äì360 nm)", w:10},
          {item:"broadband ion stream", w:20},
          {item:"confined plasma packet", w:18},
          {item:"Ka‚Äëband (26‚Äì40 GHz)", w:20},
        ]);
        out["Beam divergence"] = `${fmt(randBetween(rng, 0.12, 1.8),2)} mrad`;
        out["Duty cycle"] = `${fmt(randBetween(rng, 6, 24) * (tier.mult),0)} %`;
      }

      return { specs: out, features: extras };
    }

    function genMissile(rng, tier, highCrunch){
      const types = [
        {item:"Micro‚Äëmissile rack", w:14},
        {item:"Short‚Äërange missile", w:24},
        {item:"Medium‚Äërange missile", w:22},
        {item:"Long‚Äërange missile", w:16},
        {item:"Torpedo", w:14},
        {item:"Cruise ordnance", w:10},
      ];
      const role = pickWeighted(rng, types);
      const mult = tier.mult;

      const seeker = pickWeighted(rng, [
        {item:"IR/optical", w:26},
        {item:"active radar", w:24},
        {item:"passive RF", w:12},
        {item:"lidar", w:10},
        {item:"multi‚Äëspectral", w:22},
        {item:"semi‚Äëactive laser", w:6},
      ]);

      const warhead = pickWeighted(rng, [
        {item:"shaped charge", w:22},
        {item:"fragmentation", w:22},
        {item:"thermobaric", w:14},
        {item:"EMP", w:12},
        {item:"kinetic penetrator", w:20},
        {item:"cluster submunitions", w:10},
      ]);

      let range_km = randBetween(rng, 2, 28) * (role.includes("Medium") ? 2.1 : 1) * (role.includes("Long") ? 4.5 : 1) * (role.includes("Cruise") ? 7.5 : 1) * (role.includes("Torpedo") ? 3.8 : 1);
      range_km *= (0.95 + (mult-1)*0.85);

      const speed_mps = randBetween(rng, 240, 560) * (role.includes("Micro") ? 0.8 : 1) * (role.includes("Torpedo") ? 0.75 : 1) * (0.96 + (mult-1)*0.75);
      const lock_s = randBetween(rng, 0.8, 3.8) / (0.92 + (mult-1)*0.9);
      const mass_kg = randBetween(rng, 8, 42) * (role.includes("Micro") ? 0.35 : 1) * (role.includes("Torpedo") ? 4.5 : 1) * (role.includes("Cruise") ? 6.0 : 1);
      const length_m = Math.max(0.28, randBetween(rng, 0.45, 2.2) * (role.includes("Micro") ? 0.55 : 1) * (role.includes("Torpedo") ? 2.4 : 1) * (role.includes("Cruise") ? 2.9 : 1));

      // Fictional yield number: keep it as relative, not a real explosive recipe.
      const yield_MJ = randBetween(rng, 8, 110) * (role.includes("Micro") ? 0.55 : 1) * (role.includes("Torpedo") ? 3.0 : 1) * (role.includes("Cruise") ? 3.8 : 1) * (0.9 + (mult-1)*0.8);

      const extras = [];
      const extraCount = tier.quirks + (highCrunch ? 1 : 0);
      while (extras.length < extraCount){
        const f = pick(rng, NAME_BITS.missileFeatures);
        if (!extras.includes(f)) extras.push(f);
      }

      const out = {
        Role: role,
        "Seeker": seeker,
        "Warhead": warhead,
        "Range": `${fmt(range_km,1)} km`,
        "Top speed": `${fmt(speed_mps,0)} m/s`,
        "Lock time": `${fmt(lock_s,2)} s`,
        "Warhead yield": `${fmt(yield_MJ,0)} MJ (fictional)`,
        "Length": `${fmt(length_m,2)} m`,
        "Mass": `${fmt(mass_kg,1)} kg`,
      };

      if (highCrunch){
        out["Propulsion"] = pickWeighted(rng, [
          {item:"dual‚Äëpulse solid", w:26},
          {item:"throttleable hybrid", w:18},
          {item:"electric ducted", w:10},
          {item:"staged micro‚Äëturbine", w:10},
          {item:"cryogenic monoprop", w:16},
          {item:"scram‚Äëassist", w:20},
        ]);
        out["Turn rate"] = `${fmt(randBetween(rng, 12, 68) * (role.includes("Micro") ? 1.4 : 1),0)} ¬∞/s`;
        out["Countermeasures"] = pickWeighted(rng, [
          {item:"flare‚Äëresistant", w:35},
          {item:"chaff‚Äëresistant", w:25},
          {item:"multi‚Äëpath tolerant", w:22},
          {item:"standard", w:18},
        ]);
      }

      return { specs: out, features: extras };
    }

    function genExotic(rng, tier, highCrunch){
      const types = [
        {item:"Railgun", w:26},
        {item:"Gauss carbine", w:20},
        {item:"Graviton projector", w:16},
        {item:"EMP disrupter", w:14},
        {item:"Nanite flechette sprayer", w:12},
        {item:"Antimatter lance (contained)", w:12},
      ];
      const role = pickWeighted(rng, types);
      const mult = tier.mult;

      const mass_kg = randBetween(rng, 3.2, 9.5) * (role.includes("Rail") ? 1.35 : 1) * (role.includes("Antimatter") ? 1.65 : 1);
      const range_m = randBetween(rng, 180, 1100) * (role.includes("Rail") ? 1.5 : 1) * (role.includes("Graviton") ? 1.1 : 1) * (0.95 + (mult-1)*0.9);

      const power_MW = randBetween(rng, 0.12, 1.8) * (role.includes("Graviton") ? 1.7 : 1) * (role.includes("Antimatter") ? 2.2 : 1) * (role.includes("EMP") ? 1.3 : 1) * (0.95 + (mult-1)*0.9);
      const cap_MJ = power_MW * randBetween(rng, 0.9, 4.0);

      const stability = randBetween(rng, 0.65, 0.98) / (role.includes("Nanite") ? 1.1 : 1);

      const out = {
        Role: role,
        "Effective range": `${fmt(range_m,0)} m`,
        "Power draw": `${fmt(power_MW,2)} MW`,
        "Capacitor": `${fmt(cap_MJ,2)} MJ`,
        "Field stability": `${fmt(stability,2)} (rel.)`,
        "Mass": `${fmt(mass_kg,1)} kg`,
      };

      if (role.includes("Rail") || role.includes("Gauss")){
        const proj_g = randBetween(rng, 6, 95) * (role.includes("Rail") ? 2.2 : 1);
        const v_ms = randBetween(rng, 1600, 5200) * (0.95 + (mult-1)*0.9);
        const mj = 0.5 * (proj_g/1000) * v_ms * v_ms / 1e6;
        out["Projectile mass"] = `${fmt(proj_g,1)} g`;
        out["Muzzle velocity"] = `${fmt(v_ms,0)} m/s`;
        out["Muzzle energy"] = `${fmt(mj,2)} MJ`;
      }

      if (highCrunch){
        out["Containment"] = pickWeighted(rng, [
          {item:"reinforced Faraday cage", w:24},
          {item:"metamaterial flux shroud", w:18},
          {item:"vacuum‚Äëphase bottle", w:14},
          {item:"superconducting ring lattice", w:26},
          {item:"inertial damp cradle", w:18},
        ]);
        out["Failure mode"] = pickWeighted(rng, [
          {item:"hard lockout", w:38},
          {item:"thermal runaway", w:18},
          {item:"field collapse", w:22},
          {item:"capacitor vent", w:22},
        ]);
      }

      const extras = [];
      const baseList = role.includes("Rail") || role.includes("Gauss") ? NAME_BITS.features : NAME_BITS.exoticFeatures;
      const extraCount = tier.quirks + (highCrunch ? 1 : 0);
      while (extras.length < extraCount){
        const f = pick(rng, baseList);
        if (!extras.includes(f)) extras.push(f);
      }

      return { specs: out, features: extras };
    }

    function makeLore(rng, factionName, manufacturerName, category, tierLabel){
      const usage = {
        projectile:["boarding actions","dust‚Äëworld patrols","habitat security","close‚Äëquarters breaches","mercenary contracts"],
        energy:["reactor‚Äërich strike teams","shipboard corridors","thermal‚Äëthin atmospheres","quiet interdictions","exosuit detachments"],
        missile:["fleet screens","high‚Äëorbit denial","convoy ambushes","carrier defence","station sieges"],
        exotic:["black‚Äëlab field trials","corporate deniable ops","counter‚Äëarmour experiments","anomaly containment","prototype tournaments"],
      };
      const why = pick(rng, usage[category] || usage.projectile);
      const scandal = pickWeighted(rng, [
        {item:"after an embarrassing procurement audit", w:18},
        {item:"to undercut a rival‚Äôs flagship line", w:20},
        {item:"in response to pirate tactic shifts", w:20},
        {item:"following a disastrous heat‚Äëbloom incident", w:14},
        {item:"once Caelum relays went intermittent", w:16},
        {item:"after field reports demanded ‚Äòsomething that simply works‚Äô", w:12},
      ]);
      const note = pickWeighted(rng, [
        {item:"The earliest units have collector value ‚Äî mostly for the scars.", w:18},
        {item:"Crew call it reliable, which is the nicest thing anyone says in the Spur.", w:20},
        {item:"It‚Äôs banned in three Freeholds and celebrated in five more.", w:16},
        {item:"If it hums at idle, you‚Äôre fine. If it sings, drop it.", w:14},
        {item:"Officially ‚Äòlimited issue‚Äô. Unofficially, it‚Äôs everywhere.", w:18},
        {item:"It ships with more warnings than spare parts.", w:14},
      ]);
      return `${tierLabel} ${category} system commissioned by the ${factionName} and built by ${manufacturerName} for ${why}, ${scandal}. ${note}`;
    }

    // -----------------------------
    // Schematic canvas (small)
    // -----------------------------
    function drawSchematic(canvas, category, rng){
      const ctx = canvas.getContext("2d");
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const w = canvas.clientWidth, h = canvas.clientHeight;
      canvas.width = Math.floor(w*dpr);
      canvas.height = Math.floor(h*dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);

      // Background
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = "rgba(0,0,0,.25)";
      ctx.fillRect(0,0,w,h);

      // Guide grid
      ctx.globalAlpha = 0.22;
      ctx.strokeStyle = "rgba(255,255,255,.22)";
      ctx.lineWidth = 1;
      for (let x=0; x<=w; x+=20){
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
      }
      for (let y=0; y<=h; y+=20){
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
      }
      ctx.globalAlpha = 1;

      // Silhouette
      const cx = w*0.12;
      const cy = h*0.55;
      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(234,240,255,.85)";
      ctx.fillStyle = "rgba(122,168,255,.18)";

      function roundedRect(x,y,ww,hh,r){
        ctx.beginPath();
        ctx.moveTo(x+r,y);
        ctx.arcTo(x+ww,y,x+ww,y+hh,r);
        ctx.arcTo(x+ww,y+hh,x,y+hh,r);
        ctx.arcTo(x,y+hh,x,y,r);
        ctx.arcTo(x,y,x+ww,y,r);
        ctx.closePath();
      }

      const jitter = ()=> (rng ? (rng()-0.5)*6 : 0);

      if (category === "missile"){
        const bodyW = w*0.68;
        const bodyH = h*0.18;
        const x = cx, y = cy - bodyH/2;
        roundedRect(x,y,bodyW,bodyH,12);
        ctx.fill(); ctx.stroke();
        // Nose
        ctx.beginPath();
        ctx.moveTo(x+bodyW, y+bodyH/2);
        ctx.lineTo(x+bodyW+38, y+bodyH/2 + jitter());
        ctx.lineTo(x+bodyW, y+bodyH);
        ctx.closePath();
        ctx.fill(); ctx.stroke();
        // Fins
        ctx.globalAlpha = 0.9;
        ctx.beginPath();
        ctx.moveTo(x+bodyW*0.18, y);
        ctx.lineTo(x+bodyW*0.28, y-22);
        ctx.lineTo(x+bodyW*0.36, y);
        ctx.closePath();
        ctx.fill(); ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x+bodyW*0.18, y+bodyH);
        ctx.lineTo(x+bodyW*0.28, y+bodyH+22);
        ctx.lineTo(x+bodyW*0.36, y+bodyH);
        ctx.closePath();
        ctx.fill(); ctx.stroke();
        ctx.globalAlpha = 1;
      } else if (category === "energy"){
        // Emitter + spine
        const spineW = w*0.62;
        const spineH = h*0.12;
        const x = cx, y = cy - spineH/2;
        roundedRect(x,y,spineW,spineH,10);
        ctx.fill(); ctx.stroke();
        roundedRect(x+spineW*0.66,y-18,spineW*0.22,spineH+36,14);
        ctx.fill(); ctx.stroke();
        // Lens
        ctx.beginPath();
        ctx.ellipse(x+spineW+34, cy, 26, 18, 0, 0, Math.PI*2);
        ctx.fill(); ctx.stroke();
        // Little rays
        ctx.globalAlpha = 0.75;
        for (let i=0;i<5;i++){
          const a = -0.25 + i*0.125;
          ctx.beginPath();
          ctx.moveTo(x+spineW+60, cy);
          ctx.lineTo(x+spineW+110, cy + Math.sin(a*10)*18);
          ctx.stroke();
        }
        ctx.globalAlpha = 1;
      } else if (category === "exotic"){
        // Coil + cage
        const baseW = w*0.55;
        const baseH = h*0.14;
        const x = cx, y = cy - baseH/2;
        roundedRect(x,y,baseW,baseH,12);
        ctx.fill(); ctx.stroke();
        // Coil rings
        ctx.globalAlpha = 0.9;
        for (let i=0;i<7;i++){
          const rx = x+baseW*0.45 + i*18;
          ctx.beginPath();
          ctx.ellipse(rx, cy, 10, 22, 0, 0, Math.PI*2);
          ctx.stroke();
        }
        ctx.globalAlpha = 1;
        // Cage
        roundedRect(x+baseW*0.72, y-22, baseW*0.32, baseH+44, 16);
        ctx.fill(); ctx.stroke();
      } else {
        // Projectile / kinetic default: receiver + barrel
        const recvW = w*0.40;
        const recvH = h*0.16;
        const x = cx, y = cy - recvH/2;
        roundedRect(x,y,recvW,recvH,12);
        ctx.fill(); ctx.stroke();
        // Barrel
        ctx.beginPath();
        ctx.moveTo(x+recvW, cy - 6);
        ctx.lineTo(w*0.92, cy - 6);
        ctx.lineTo(w*0.92, cy + 6);
        ctx.lineTo(x+recvW, cy + 6);
        ctx.closePath();
        ctx.fill(); ctx.stroke();
        // Grip
        ctx.beginPath();
        ctx.moveTo(x+recvW*0.28, y+recvH);
        ctx.lineTo(x+recvW*0.36, y+recvH+44);
        ctx.lineTo(x+recvW*0.48, y+recvH+40);
        ctx.lineTo(x+recvW*0.42, y+recvH);
        ctx.closePath();
        ctx.fill(); ctx.stroke();
      }

      // Label
      ctx.fillStyle = "rgba(234,240,255,.85)";
      ctx.font = "12px " + getComputedStyle(document.documentElement).getPropertyValue('--mono');
      ctx.fillText("schematic (stylised)", 10, 16);
    }

    // -----------------------------
    // Starfield background canvas
    // -----------------------------
    function startStarfield(){
      const canvas = document.getElementById("bgCanvas");
      const ctx = canvas.getContext("2d");
      let W=0,H=0,dpr=1;

      const rng = Math.random; // background can be non‚Äëseeded
      const stars = [];
      const STAR_COUNT = 360;

      function resize(){
        dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        W = Math.floor(window.innerWidth * dpr);
        H = Math.floor(window.innerHeight * dpr);
        canvas.width = W;
        canvas.height = H;
        canvas.style.width = window.innerWidth + "px";
        canvas.style.height = window.innerHeight + "px";
        stars.length = 0;
        for (let i=0;i<STAR_COUNT;i++){
          stars.push({
            x: rng()*W,
            y: rng()*H,
            z: rng(),
            r: 0.6 + rng()*1.6,
            s: 0.12 + rng()*0.55,
          });
        }
      }

      function tick(){
        ctx.clearRect(0,0,W,H);
        ctx.fillStyle = "rgba(7,10,18,1)";
        ctx.fillRect(0,0,W,H);

        for (const st of stars){
          st.x -= st.s * (0.6 + st.z*1.6);
          st.y += st.s * (0.12 + st.z*0.5);
          if (st.x < -10) st.x = W + 10;
          if (st.y > H + 10) st.y = -10;

          const a = 0.18 + st.z*0.75;
          ctx.globalAlpha = a;
          ctx.beginPath();
          ctx.arc(st.x, st.y, st.r, 0, Math.PI*2);
          ctx.fillStyle = "rgba(234,240,255,1)";
          ctx.fill();
        }
        ctx.globalAlpha = 1;
        requestAnimationFrame(tick);
      }

      window.addEventListener("resize", resize);
      resize();
      tick();
    }

    // -----------------------------
    // UI wiring
    // -----------------------------
    const els = {
      category: document.getElementById("category"),
      tier: document.getElementById("tier"),
      faction: document.getElementById("faction"),
      manufacturer: document.getElementById("manufacturer"),
      seed: document.getElementById("seed"),
      count: document.getElementById("count"),
      format: document.getElementById("format"),
      includeNickname: document.getElementById("includeNickname"),
      includeLore: document.getElementById("includeLore"),
      highCrunch: document.getElementById("highCrunch"),
      out: document.getElementById("out"),
      btnGenerate: document.getElementById("btnGenerate"),
      btnBatch: document.getElementById("btnBatch"),
      btnCopyName: document.getElementById("btnCopyName"),
      btnCopyJSON: document.getElementById("btnCopyJSON"),
      btnDownload: document.getElementById("btnDownload"),
    };

    function populateSelect(select, items, defaultId){
      select.innerHTML = "";
      for (const it of items){
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = it.name;
        select.appendChild(opt);
      }
      if (defaultId) select.value = defaultId;
    }

    populateSelect(els.faction, FACTIONS, "orpheus");
    populateSelect(els.manufacturer, MANUFACTURERS, "novatek");

    function resolveCategory(raw){
      if (raw === "any"){
        return pickWeighted(Math.random, [
          {item:"projectile", w:32},
          {item:"energy", w:26},
          {item:"missile", w:22},
          {item:"exotic", w:20},
        ]);
      }
      return raw;
    }

    function categoryLabel(cat){
      return {
        projectile:"Projectile / kinetic",
        energy:"Energy",
        missile:"Missiles / ordnance",
        exotic:"Exotic / experimental",
      }[cat] || cat;
    }

    function makeProfile(seedStr, categoryRaw){
      // Basic integrity checks (helps avoid silent failure if datasets are edited).
      if (!FACTIONS.length || !MANUFACTURERS.length) throw new Error("Dataset missing: factions/manufacturers.");
      for (const k of ["adjectives","nouns","variants"]){
        if (!NAME_BITS[k] || !NAME_BITS[k].length) throw new Error(`Dataset missing: NAME_BITS.${k}`);
      }

      const factionObj = FACTIONS.find(f=>f.id === els.faction.value) || FACTIONS[0];
      const mfgObj = MANUFACTURERS.find(m=>m.id === els.manufacturer.value) || MANUFACTURERS[0];
      const tier = TIERS[els.tier.value] || TIERS.rare;

      // If user provides no seed, we still create a stable one so export includes it.
      const autoSeed = seedStr && seedStr.trim().length ? seedStr.trim() : `seed-${Date.now()}-${Math.floor(Math.random()*1e6)}`;
      const rng = makeRng(autoSeed);

      const category = resolveCategory(categoryRaw);
      const name = makeWeaponName(rng, mfgObj.name, category, els.includeNickname.checked);

      // Generate category specs
      const highCrunch = els.highCrunch.checked;
      let data;
      if (category === "projectile") data = genProjectile(rng, tier, highCrunch);
      else if (category === "energy") data = genEnergy(rng, tier, highCrunch);
      else if (category === "missile") data = genMissile(rng, tier, highCrunch);
      else data = genExotic(rng, tier, highCrunch);

      const features = data.features;
      const specs = data.specs;

      const service = pickWeighted(rng, [
        {item:"Frontier Auxiliary", w:18},
        {item:"Orbital Marines", w:20},
        {item:"Void Customs", w:12},
        {item:"Fleet Security", w:16},
        {item:"Privateer Corps", w:12},
        {item:"Relay Wardens", w:12},
        {item:"Corporate Detail", w:10},
      ]);

      const tags = [];
      tags.push(categoryLabel(category));
      tags.push(tier.label);
      tags.push(factionObj.name);
      if (rng() < 0.55) tags.push(service);

      const lore = els.includeLore.checked
        ? makeLore(rng, factionObj.name, mfgObj.name, category, tier.label)
        : "";

      const profile = {
        name,
        category,
        tier: tier.label,
        originFaction: factionObj.name,
        manufacturer: mfgObj.name,
        serviceTag: service,
        seed: autoSeed,
        features,
        specs,
        lore,
        generatedAt: new Date().toISOString(),
      };

      return { profile, rngForArt: rng };
    }

    function toMarkdown(profile){
      const lines = [];
      lines.push(`# ${profile.name}`);
      lines.push("");
      lines.push(`- **Category:** ${categoryLabel(profile.category)}`);
      lines.push(`- **Tier:** ${profile.tier}`);
      lines.push(`- **Manufacturer:** ${profile.manufacturer}`);
      lines.push(`- **Origin:** ${profile.originFaction}`);
      lines.push(`- **Service tag:** ${profile.serviceTag}`);
      lines.push(`- **Seed:** \`${profile.seed}\``);
      lines.push("");
      lines.push("## Technical specifications");
      for (const [k,v] of Object.entries(profile.specs)){
        lines.push(`- **${k}:** ${v}`);
      }
      lines.push("");
      lines.push("## Notable features");
      for (const f of profile.features) lines.push(`- ${f}`);
      if (profile.lore){
        lines.push("");
        lines.push("## Lore");
        lines.push(profile.lore);
      }
      return lines.join("\n");
    }

    function toPlainText(profile){
      const lines = [];
      lines.push(profile.name);
      lines.push(`${categoryLabel(profile.category)} ‚Ä¢ ${profile.tier} ‚Ä¢ ${profile.originFaction} ‚Ä¢ ${profile.manufacturer}`);
      lines.push(`Seed: ${profile.seed}`);
      lines.push("\nSpecs:");
      for (const [k,v] of Object.entries(profile.specs)) lines.push(`- ${k}: ${v}`);
      lines.push("\nFeatures:");
      for (const f of profile.features) lines.push(`- ${f}`);
      if (profile.lore) lines.push("\nLore:\n" + profile.lore);
      return lines.join("\n");
    }

    function renderProfiles(profiles, rngForArt){
      const first = profiles[0];

      const tagHtml = first.tags ? first.tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("") : "";

      // Left: schematic
      const schematic = `
        <div class="panel">
          <div class="ph">Canvas schematic</div>
          <div class="pb">
            <canvas id="schematicCanvas" style="width:100%; height:180px; border-radius:14px; display:block;"></canvas>
            <div class="hr"></div>
            <div class="small">Stylised silhouette to help visually distinguish categories.</div>
          </div>
        </div>
      `;

      // Right: specs + json
      const specsRows = Object.entries(first.specs)
        .map(([k,v])=>`<tr><td>${escapeHtml(k)}</td><td>${escapeHtml(String(v))}</td></tr>`).join("");

      const featureList = first.features.map(f=>`<li>${escapeHtml(f)}</li>`).join("");

      const loreBlock = first.lore ? `
        <div class="panel" style="margin-top:12px;">
          <div class="ph">Lore note</div>
          <div class="pb"><div class="small" style="color:rgba(234,240,255,.92); line-height:1.55;">${escapeHtml(first.lore)}</div></div>
        </div>
      ` : "";

      const json = JSON.stringify(profiles.length === 1 ? first : profiles, null, 2);

      const batchNote = profiles.length > 1
        ? `<div class="small" style="margin-top:8px;">Batch generated: <b>${profiles.length}</b> profiles (export/copy uses the entire batch).</div>`
        : "";

      els.out.innerHTML = `
        <div class="outTitle">
          <div style="flex:1; min-width:260px;">
            <h2 class="name">${escapeHtml(first.name)}</h2>
            <div class="meta">
              <span class="tag">${escapeHtml(categoryLabel(first.category))}</span>
              <span class="tag">${escapeHtml(first.tier)}</span>
              <span class="tag">${escapeHtml(first.originFaction)}</span>
              <span class="tag">${escapeHtml(first.manufacturer)}</span>
              <span class="tag">Seed: <span style="font-family:var(--mono)">${escapeHtml(first.seed)}</span></span>
            </div>
            ${batchNote}
          </div>
        </div>

        <div class="split">
          ${schematic}

          <div>
            <div class="panel">
              <div class="ph">Technical specifications</div>
              <div class="pb">
                <table>
                  ${specsRows}
                </table>
              </div>
            </div>

            <div class="panel" style="margin-top:12px;">
              <div class="ph">Notable features</div>
              <div class="pb"><ul style="margin:0; padding-left:18px; line-height:1.6;">${featureList}</ul></div>
            </div>

            ${loreBlock}

            <div class="panel" style="margin-top:12px;">
              <div class="ph">Export preview</div>
              <div class="pb"><pre class="mono" id="exportPreview">${escapeHtml(json)}</pre></div>
            </div>
          </div>
        </div>
      `;

      // Draw schematic on canvas
      const c = document.getElementById("schematicCanvas");
      if (c){
        drawSchematic(c, first.category, rngForArt);
        window.addEventListener("resize", ()=>drawSchematic(c, first.category, rngForArt), {passive:true});
      }

      // Store last export
      window.__lastExport = {
        profiles,
        json,
      };
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function exportContent(){
      const last = window.__lastExport;
      if (!last) return {filename:"weapon.json", mime:"application/json", content:"{}"};

      const format = els.format.value;
      const profiles = last.profiles;

      if (format === "json"){
        const content = JSON.stringify(profiles.length === 1 ? profiles[0] : profiles, null, 2);
        return {filename: profiles.length === 1 ? "weapon_profile.json" : "weapon_batch.json", mime:"application/json", content};
      }

      if (format === "md"){
        const content = profiles.map(p=>toMarkdown(p)).join("\n\n---\n\n");
        return {filename: profiles.length === 1 ? "weapon_profile.md" : "weapon_batch.md", mime:"text/markdown", content};
      }

      const content = profiles.map(p=>toPlainText(p)).join("\n\n" + "=".repeat(44) + "\n\n");
      return {filename: profiles.length === 1 ? "weapon_profile.txt" : "weapon_batch.txt", mime:"text/plain", content};
    }

    function generate(isBatch){
      try{
        setStatus("Generating‚Ä¶");

        const seedStr = els.seed.value;
        const categoryRaw = els.category.value;
        const count = isBatch ? safeNumberInput(els.count, 1, 20, 5) : 1;

        const profiles = [];
        let rngForArt = null;

        // Each profile gets its own sub-seed derived from base seed so batches are stable too.
        const baseSeed = seedStr && seedStr.trim().length ? seedStr.trim() : `seed-${Date.now()}-${Math.floor(Math.random()*1e6)}`;
        for (let i=0;i<count;i++){
          const subSeed = `${baseSeed}::${i+1}`;
          const { profile, rngForArt: r } = makeProfile(subSeed, categoryRaw);
          // Tags for display (not strictly necessary in JSON)
          profile.tags = [categoryLabel(profile.category), profile.tier, profile.originFaction, profile.manufacturer];
          profiles.push(profile);
          if (!rngForArt) rngForArt = r;
        }

        renderProfiles(profiles, rngForArt);
        setStatus(isBatch ? `Batch complete (${count}).` : "Done.");
      }catch(err){
        console.error(err);
        els.out.innerHTML = `<div class="panel error"><div class="ph">Error</div><div class="pb"><div class="small">${escapeHtml(err && err.message ? err.message : String(err))}</div></div></div>`;
        setStatus("Generation error.", true);
      }
    }

    // Buttons
    els.btnGenerate.addEventListener("click", ()=>generate(false));
    els.btnBatch.addEventListener("click", ()=>generate(true));

    els.btnCopyName.addEventListener("click", async ()=>{
      const last = window.__lastExport;
      if (!last){ setStatus("Nothing to copy yet.", true); return; }
      const name = last.profiles[0].name;
      const ok = await copyToClipboard(name);
      setStatus(ok ? "Name copied." : "Copy failed (browser blocked).", !ok);
    });

    els.btnCopyJSON.addEventListener("click", async ()=>{
      const last = window.__lastExport;
      if (!last){ setStatus("Nothing to copy yet.", true); return; }
      const exp = exportContent().content;
      const ok = await copyToClipboard(exp);
      setStatus(ok ? "Export copied." : "Copy failed (browser blocked).", !ok);
    });

    els.btnDownload.addEventListener("click", ()=>{
      const last = window.__lastExport;
      if (!last){ setStatus("Nothing to download yet.", true); return; }
      const exp = exportContent();
      downloadBlob(exp.filename, exp.content, exp.mime);
      setStatus(`Downloaded ${exp.filename}.`);
    });

    // Kick off background
    startStarfield();

    // Auto-generate one on load for convenience
    generate(false);
  </script>
</body>
</html>
